# Create your virtual lab

## Minimal network configuration on each host

Set computer hostname:
```bash
user@node1:~$ cat /etc/hostname
node1
```

And the hosts file:
```bash
user@node1:~$ cat /etc/hosts
127.0.0.1       localhost
127.0.1.1       node1.lab.lan   node1

# The following lines are desirable for IPv6 capable hosts
::1     localhost ip6-localhost ip6-loopback
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters
```

## Configuring node1 and node2 network interface:

Set IP address in static mode:
```bash
user@node1:~$ cat /etc/network/interfaces
# This file describes the network interfaces available on your system
# and how to activate them. For more information, see interfaces(5).

source /etc/network/interfaces.d/*

# The loopback network interface
auto lo
iface lo inet loopback

# The primary network interface
allow-hotplug enp0s3
iface enp0s3 inet static
        address 192.168.45.11/24
```
Then, do the same on node2

=== router ===

user@router:~$ cat /etc/hostname
router

user@router:~$ cat /etc/hosts
127.0.0.1       localhost
127.0.1.1       router.lab.lan  router

# The following lines are desirable for IPv6 capable hosts
::1     localhost ip6-localhost ip6-loopback
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters

user@router:~$ sudo  apt-get install iptables-persistent

user@router:~$ sudo  iptables -t nat -A POSTROUTING -s 192.168.45.0/24 -o enp0s3 -j MASQUERADE
user@router:~$ sudo  iptables-save > /etc/iptables/rules.v4

user@router:~$ cat /etc/iptables/rules.v4
# Generated by iptables-save v1.8.11 (nf_tables) on Mon Oct 20 09:00:15 2025
*nat
:PREROUTING ACCEPT [0:0]
:INPUT ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:POSTROUTING ACCEPT [7:556]
-A POSTROUTING -s 192.168.45.0/24 -o enp0s3 -j MASQUERADE
COMMIT
# Completed on Mon Oct 20 09:00:15 2025

user@router:~$ sudo iptables -t nat -L
Chain PREROUTING (policy ACCEPT)
target     prot opt source               destination

Chain INPUT (policy ACCEPT)
target     prot opt source               destination

Chain OUTPUT (policy ACCEPT)
target     prot opt source               destination

Chain POSTROUTING (policy ACCEPT)
target     prot opt source               destination
MASQUERADE  all  --  192.168.45.0/24      anywhere

user@router:~$ sudo sysctl -a | grep 'net.ipv4.ip_forward'
net.ipv4.ip_forward = 0
net.ipv4.ip_forward_update_priority = 1
net.ipv4.ip_forward_use_pmtu = 0

user@router:~$ echo 'net.ipv4.ip_forward = 1' | sudo tee -a /etc/sysctl.d/99-custom.conf > /dev/null

user@router:~$ sudo sysctl --system
* Applying /usr/lib/sysctl.d/10-coredump-debian.conf ...
* Applying /usr/lib/sysctl.d/50-default.conf ...
* Applying /usr/lib/sysctl.d/50-pid-max.conf ...
* Applying /etc/sysctl.d/99-custom.conf ...
kernel.core_pattern = core
kernel.sysrq = 0x01b6
kernel.core_uses_pid = 1
net.ipv4.conf.default.rp_filter = 2
net.ipv4.conf.enp0s3.rp_filter = 2
net.ipv4.conf.enp0s8.rp_filter = 2
net.ipv4.conf.lo.rp_filter = 2
net.ipv4.conf.default.accept_source_route = 0
net.ipv4.conf.enp0s3.accept_source_route = 0
net.ipv4.conf.enp0s8.accept_source_route = 0
net.ipv4.conf.lo.accept_source_route = 0
net.ipv4.conf.default.promote_secondaries = 1
net.ipv4.conf.enp0s3.promote_secondaries = 1
net.ipv4.conf.enp0s8.promote_secondaries = 1
net.ipv4.conf.lo.promote_secondaries = 1
net.ipv4.ping_group_range = 0 2147483647
net.core.default_qdisc = fq_codel
fs.protected_hardlinks = 1
fs.protected_symlinks = 1
fs.protected_regular = 2
fs.protected_fifos = 1
vm.max_map_count = 1048576
kernel.pid_max = 4194304
net.ipv4.ip_forward = 1

user@router:~$ sudo sysctl -a | grep 'net.ipv4.ip_forward'
net.ipv4.ip_forward = 1
net.ipv4.ip_forward_update_priority = 1
net.ipv4.ip_forward_use_pmtu = 0

Ajouter la passerelle par défaut dans node1 et 2 :

user@node1:~$ cat /etc/network/interfaces
# This file describes the network interfaces available on your system
# and how to activate them. For more information, see interfaces(5).

source /etc/network/interfaces.d/*

# The loopback network interface
auto lo
iface lo inet loopback

# The primary network interface
allow-hotplug enp0s3
iface enp0s3 inet static
        address 192.168.45.11/24
        gateway 192.168.45.254

== dnsrecur ==

user@dnsrecur:~$ cat /etc/hostname
dnsrecur

user@dnsrecur:~$ cat /etc/hosts
127.0.0.1       localhost
127.0.1.1       dnsrecur.lab.lan        dnsrecur

# The following lines are desirable for IPv6 capable hosts
::1     localhost ip6-localhost ip6-loopback
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters

user@dnsrecur:~$ cat /etc/network/interfaces
# This file describes the network interfaces available on your system
# and how to activate them. For more information, see interfaces(5).

source /etc/network/interfaces.d/*

# The loopback network interface
auto lo
iface lo inet loopback

# The primary network interface
allow-hotplug enp0s3
iface enp0s3 inet static
        address 192.168.45.1/24
        gateway 192.168.45.254

user@dnsrecur:~$ echo "nameserver 8.8.8.8" | sudo tee /etc/resolv.conf > /dev/null

user@dnsrecur:~$ cat /etc/resolv.conf
nameserver 8.8.8.8

user@dnsrecur:~$ sudo apt-get install bind9

user@dnsrecur:~$ cat /etc/bind/named.conf.options
options {
        directory "/var/cache/bind";
        listen-on { 192.168.45.1; 127.0.0.1; };
        listen-on-v6 { none; };
        allow-recursion { 192.168.45.0/24; localhost; };
        allow-query     { 192.168.45.0/24; localhost; };
        recursion yes;
        dnssec-validation no;
        auth-nxdomain no;
        forwarders {
                1.1.1.1;
                8.8.8.8;
        };
        forward only;
};

user@dnsrecur:~$ named-checkconf

user@dnsrecur:~$ sudo systemctl restart bind9

user@dnsrecur:~$ sudo grep bind /var/log/syslog
…
2025-10-20T10:25:53.904634+02:00 dnsrecur named[1107]: built with  '--build=x86_64-linux-gnu' '--prefix=/usr' '--includedir=${prefix}/include' '--mandir=${prefix}/share/man' '--infodir=${prefix}/share/info' '--sysconfdir=/etc' '--localstatedir=/var' '--disable-option-checking' '--disable-silent-rules' '--libdir=${prefix}/lib/x86_64-linux-gnu' '--runstatedir=/run' '--disable-maintainer-mode' '--disable-dependency-tracking' '--libdir=/usr/lib/x86_64-linux-gnu' '--sysconfdir=/etc/bind' '--with-python=python3' '--localstatedir=/' '--enable-threads' '--enable-largefile' '--with-libtool' '--enable-shared' '--disable-static' '--with-gost=no' '--with-openssl=/usr' '--with-gssapi=yes' '--with-libidn2' '--with-json-c' '--with-lmdb=/usr' '--with-gnu-ld' '--with-maxminddb' '--with-atf=no' '--enable-ipv6' '--enable-rrl' '--enable-filter-aaaa' '--disable-native-pkcs11' '--enable-dnstap' 'build_alias=x86_64-linux-gnu' 'CFLAGS=-g -O2 -Werror=implicit-function-declaration -ffile-prefix-map=/build/reproducible-path/bind9-9.20.11=. -fstack-protector-strong -fstack-clash-protection -Wformat -Werror=format-security -fcf-protection -fno-strict-aliasing -fno-delete-null-pointer-checks -DNO_VERSION_DATE -DDIG_SIGCHASE' 'LDFLAGS=-Wl,-z,relro -Wl,-z,now' 'CPPFLAGS=-Wdate-time -D_FORTIFY_SOURCE=2'
2025-10-20T10:25:53.906427+02:00 dnsrecur named[1107]: running as: named -f -u bind
2025-10-20T10:25:53.910138+02:00 dnsrecur named[1107]: loading configuration from '/etc/bind/named.conf'
…

user@dnsrecur:~$ host www.google.com 127.0.0.1
Using domain server:
Name: 127.0.0.1
Address: 127.0.0.1#53
Aliases:

www.google.com has address 172.217.18.196
www.google.com has IPv6 address 2a00:1450:4007:80e::2004
www.google.com has HTTP service bindings 1 . alpn="h2,h3"

user@dnsrecur:~$ host www.google.com 192.168.45.1
Using domain server:
Name: 192.168.45.1
Address: 192.168.45.1#53
Aliases:

www.google.com has address 172.217.18.196
www.google.com has IPv6 address 2a00:1450:4007:80e::2004
www.google.com has HTTP service bindings 1 . alpn="h2,h3"

user@dnsrecur:~$ echo "nameserver 127.0.0.1" | sudo tee /etc/resolv.conf > /dev/null

user@dnsrecur:~$ host www.google.fr
www.google.fr has address 142.250.201.163
www.google.fr has IPv6 address 2a00:1450:4007:81a::2003
www.google.fr has HTTP service bindings 1 . alpn="h2,h3"

user@node1:~$ echo "nameserver 192.168.45.1" | sudo tee /etc/resolv.conf > /dev/null
user@node1:~$ host www.google.com
www.google.com has address 172.217.18.196
www.google.com has IPv6 address 2a00:1450:4007:805::2004
www.google.com has HTTP service bindings 1 . alpn="h2,h3"

user@router:~$ cat /etc/dhcpcd.conf
…
nohook resolv.conf

user@router:~$ echo "nameserver 192.168.45.1" | sudo tee /etc/resolv.conf > /dev/null

user@router:~$ cat /etc/resolv.conf
nameserver 192.168.45.1

user@router:~$ host www.google.com
www.google.com has address 172.217.18.196
www.google.com has IPv6 address 2a00:1450:4007:805::2004
www.google.com has HTTP service bindings 1 . alpn="h2,h3"

== dnsauth ==

user@dnsauth:~$ cat /etc/hostname
dnsauth

user@dnsauth:~$ cat /etc/hosts
127.0.0.1       localhost
127.0.1.1       dnsauth.lab.lan dnsauth

# The following lines are desirable for IPv6 capable hosts
::1     localhost ip6-localhost ip6-loopback
ff02::1 ip6-allnodes
ff02::2 ip6-allrouters

user@dnsauth:~$ cat /etc/network/interfaces
# This file describes the network interfaces available on your system
# and how to activate them. For more information, see interfaces(5).

source /etc/network/interfaces.d/*

# The loopback network interface
auto lo
iface lo inet loopback

# The primary network interface
allow-hotplug enp0s3
iface enp0s3 inet static
        address 192.168.45.2/24
        gateway 192.168.45.254

user@dnsauth:~$ echo "nameserver 192.168.45.1" | sudo tee /etc/resolv.conf > /dev/null

user@dnsauth:~$ cat /etc/bind/named.conf.options
options {
        directory "/var/cache/bind";
        listen-on { 192.168.45.2; 127.0.0.1; };
        listen-on-v6 { none; };
        recursion no;
};

user@dnsauth:~$ cat /etc/bind/named.conf.local
//
// Do any local configuration here
//

zone "lab.lan" {
    type master;
    file "/etc/bind/zones/db.lab.lan";
    allow-query { any; };
};

zone "45.168.192.in-addr.arpa" {
    type master;
    file "/etc/bind/zones/db.192.168.45";
    allow-query { any; };
};

user@dnsauth:~$ cat /etc/bind/zones/db.lab.lan
$TTL 3600
@   IN  SOA dnsauth.lab.lan. admin.lab.lan. (
        2025100601 ; serial
        3600       ; refresh
        900        ; retry
        1209600    ; expire
        300 )      ; minimum

    IN  NS  dnsauth.lab.lan.

dnsauth   IN  A    192.168.45.2
dnsrecur  IN  A    192.168.45.1
node1     IN  A    192.168.45.11
node2     IN  A    192.168.45.12

user@dnsauth:~$ cat /etc/bind/zones/db.192.168.45
$TTL 3600
@   IN  SOA dnsauth.lab.lan. admin.lab.lan. (
        2025100601
        3600
        900
        1209600
        300 )

    IN  NS  dnsauth.lab.lan.

2   IN  PTR dnsauth.lab.lan.
1   IN  PTR dnsrecur.lab.lan.
11  IN  PTR node1.lab.lan.
12  IN  PTR node2.lab.lan.

user@dnsauth:~$ sudo chown -R bind:bind /etc/bind/zones
user@dnsauth:~$ sudo vim.tiny /etc/bind/named.conf.options
user@dnsauth:~$ named-checkconf
user@dnsauth:~$ named-checkzone lab.lan /etc/bind
bind/                   bindresvport.blacklist
user@dnsauth:~$ named-checkzone lab.lan /etc/bind/zones/db.lab.lan
zone lab.lan/IN: loaded serial 2025100601
OK
user@dnsauth:~$ named-checkzone 45.168.192.in-addr.arpa /etc/bind/zones/db.192.168.45
zone 45.168.192.in-addr.arpa/IN: loaded serial 2025100601
OK

user@dnsauth:~$ sudo systemctl restart bind9

user@dnsauth:~$ sudo grep zone /var/log/syslog
2025-10-20T12:45:01.839269+02:00 dnsauth named[1124]: managed-keys-zone: loaded serial 2
2025-10-20T12:45:01.839408+02:00 dnsauth named[1124]: zone 45.168.192.in-addr.arpa/IN: loaded serial 2025100601
2025-10-20T12:45:01.839525+02:00 dnsauth named[1124]: zone lab.lan/IN: loaded serial 2025100601
2025-10-20T12:45:01.839719+02:00 dnsauth named[1124]: all zones loaded

user@dnsauth:~$ host node1.lab.lan 127.0.0.1
Using domain server:
Name: 127.0.0.1
Address: 127.0.0.1#53
Aliases:

node1.lab.lan has address 192.168.45.11

user@dnsauth:~$ host 192.168.45.11 127.0.0.1
Using domain server:
Name: 127.0.0.1
Address: 127.0.0.1#53
Aliases:

11.45.168.192.in-addr.arpa domain name pointer node1.lab.lan.

user@dnsauth:~$ host node1.lab.lan
Host node1.lab.lan not found: 3(NXDOMAIN)

Why ??

user@dnsrecur:~$ cat /etc/bind/named.conf.local
//
// Do any local configuration here
//

zone "lab.lan" {
    type forward;
    forward only;
    forwarders { 192.168.45.2; };
}

zone "45.168.192.in-addr.arpa" {
    type forward;
    forward only;
    forwarders { 192.168.45.2; };
};

user@dnsrecur:~$ named-checkconf

user@dnsrecur:~$ sudo systemctl restart bind9

user@router:~$ host node1.lab.lan
node1.lab.lan has address 192.168.45.11

user@router:~$ host 192.168.45.11
11.45.168.192.in-addr.arpa domain name pointer node1.lab.lan.

user@router:~$ echo "search lab.lan" | sudo tee -a /etc/resolv.conf > /dev/null
user@node1:~$ echo "search lab.lan" | sudo tee -a /etc/resolv.conf > /dev/null
user@node2:~$ echo "search lab.lan" | sudo tee -a /etc/resolv.conf > /dev/null
user@dnsrecur:~$ echo "search lab.lan" | sudo tee -a /etc/resolv.conf > /dev/null
user@dnsauth:~$ echo "search lab.lan" | sudo tee -a /etc/resolv.conf > /dev/null
